@{
    ViewData["Title"] = "Public Chat";
}
<div class="alert alert-warning">
    <h5>🔍 Authentication Debug:</h5>
    <strong>Is Authenticated:</strong> @User.Identity?.IsAuthenticated<br>
    <strong>User Name:</strong> @User.Identity?.Name<br>
    <strong>User ID Claim:</strong> @User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value<br>
    <strong>Email Claim:</strong> @User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value<br>
    <strong>Role Claim:</strong> @User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value<br>

    @if (User.Identity?.IsAuthenticated == true)
    {
        <hr>
        <strong>All Claims:</strong>

        <br>
        @foreach (var claim in User.Claims)
        {
            <small>@claim.Type: @claim.Value</small>
    
            <br>
        }
    }
    else
    {
        <div class="text-danger mt-2">⚠️ You are NOT authenticated!</div>
    }
</div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Public Chat Room</h2>
        <a asp-action="Index" class="btn btn-outline-secondary">Back to Chat Menu</a>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Logged in as: @User.Identity!.Name</h5>
        </div>
        <div class="card-body">
            <div id="messagesList" class="border rounded p-3 mb-3 bg-light" style="height: 500px; overflow-y: auto;"></div>
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." />
                <button class="btn btn-primary" id="sendButton">Send</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        connection.on("ReceiveMessage", function (userName, message, sentAt) {
            const msg = document.createElement("div");
            msg.className = "mb-2 p-2 border-bottom";
            const time = new Date(sentAt).toLocaleTimeString();
            msg.innerHTML = `
                <small class="text-muted">${time}</small>
                <strong class="text-primary">${userName}:</strong>
                <span>${message}</span>
            `;
            document.getElementById("messagesList").appendChild(msg);
            document.getElementById("messagesList").scrollTop = document.getElementById("messagesList").scrollHeight;
        });

        connection.start()
            .then(() => {
                console.log("Connected to chat!");
                document.getElementById("sendButton").addEventListener("click", sendMessage);
                document.getElementById("messageInput").addEventListener("keypress", function(e) {
                    if (e.key === 'Enter') sendMessage();
                });
            })
            .catch(err => console.error("Connection error:", err));

        function sendMessage() {
            const message = document.getElementById("messageInput").value.trim();

            if (message && connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("SendMessage", message)
                    .then(() => {
                        document.getElementById("messageInput").value = '';
                    })
                    .catch(err => console.error("Send error:", err));
            }
        }
    </script>
}